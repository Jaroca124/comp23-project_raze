<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Project Raze</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    // <script type="text/javascript" src="gun_methods.js"></script>
    // <script type="text/javascript" src="enemy.js"></script>
    // <script type="text/javascript" src="gorilla.js"></script>
    // <script type="text/javascript" src='powerups.js'></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, "game", { preload: preload, create: create, collide: collide, collide2: collide2, update: update });

function preload() {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.atlasJSONHash('sheet_small', 'assets/maps/sheet_small.png', 'assets/maps/sheet_small.json');
    game.load.image('bullet4', 'assets/bullet4.png');
    game.load.image('rude', 'assets/rude.png');
    game.load.image('rock', 'assets/maps/rock.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.load.image('gorilla', 'assets/Gorilla_1.png');
    game.load.image('grass', 'assets/maps/grass_small.png');
    game.load.image('health_25', 'assets/health_25.png');
    game.load.image('health_50', 'assets/health_50.png');
    game.load.image('health_75', 'assets/health_75.png');
    game.load.image('gun_0', 'assets/gun_0.png');
    game.load.image('gun_1', 'assets/gun_1.png');
    game.load.image('gun_2', 'assets/gun_2.png');
    game.renderer.renderSession.roundPixels = true;

    weapons = [];

}

//  Load various functions and objects
var platforms;
var score = 0;
var scoreText;
// Pistol = 0, Dual = 1, automatic = 2
var current_weapon = 1;
var fired = false;
var semi = true;
var health = 100;
var ammo = 200;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    this.cursors = game.input.keyboard.createCursorKeys();

    // Mapping new controls
    wasd = {
        up: game.input.keyboard.addKey(Phaser.Keyboard.W),
        down: game.input.keyboard.addKey(Phaser.Keyboard.S),
        right: game.input.keyboard.addKey(Phaser.Keyboard.D),
        left: game.input.keyboard.addKey(Phaser.Keyboard.A)
    };


    var bg = game.add.tileSprite(0, 0, 800,600, 'grass');
 //   var rock_test = game.add.sprite(50, 50, 'rock.png');


    // LEFTOVER FROM IMGS: The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'rude');
    player.anchor.setTo(0.5, 0.5);

    game.physics.enable(player, Phaser.Physics.ARCADE);
    //player.enableBody = true;
    player.force = {x:0.0, y:0.0};

    weapons.push(new Weapon.SingleBullet(this.game));

    gorillas = game.add.group();
    gorillas.enableBody = true;
    //viewGroup = game.add.group();
    for (var j = 0; j < 3; j++) {
        var gorilla = Gorilla(gorillas, 300 + 100*j, 300 + 100*j, player);
    }

    //Bind shot to spacebar
    game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);

    //Health
    health_powerups = game.add.group();
    for (var i = 0; i < 3; i++) {
        var health_objects = Health(health_powerups, 75, 250 + i*50, 250 + i*100);
    }
    healthText = game.add.text(16, 16, 'Health: ' + health, { fontSize: '32px', fill: '#000' });

    // Guns
    guns = game.add.group();
    var single = change_gun(guns, 0, 400, 400);
    var dual = change_gun(guns, 1, 300, 700);
    var auto = change_gun(guns, 2, 700, 300);
    gunText = game.add.text(400, 16, 'Current Gun: ' + current_weapon, { fontSize: '32px', fill: '#000' });
    
    //Ammo
    ammoText = game.add.text(16, 32, 'Ammo: ' + ammo, { fontSize: '32px', fill: '#000' });
    
    
}

function update() {

    if (ammo < 1) {
        if (current_weapon > 0) {
            current_weapon--;
            ammo = 200;
        }
        else {
            ammo = 200;
        }
    }

    if (health <= 0) {
        player.kill(true);
        gameoverText = game.add.text(300, 300, 'GAME OVER', { fontSize: '120px', fill: '#000' });
    }
    var mX = game.input.mousePointer.x;
    var mY = game.input.mousePointer.y;
    /* look at the mouse */
    player.angle = Math.atan2(player.position.x - mX, player.position.y - mY)  * -57.2957795;
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;

    if (wasd.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -400;

        //player.animations.play('left');
    }
    if (wasd.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 400;

        //player.animations.play('right');
    }
    if (wasd.up.isDown) {
        player.body.velocity.y = -400;   
    }

    if (wasd.down.isDown) {
        player.body.velocity.y = 400;    
    }
    
    // Manage guns
    if (current_weapon == 0) {
        semi = true;
    }
    else if (current_weapon == 1) {
        semi = true;
    }
    else {
        semi = false;
    }
    //Fire Gun
    /*if (game.input.activePointer.isDown) {
        determine_gun(semi, current_weapon);
    }*/
    // Pistol
    if (game.input.activePointer.isDown && semi == true && current_weapon == 0) { 
        if (!fired) {    
            weapons[0].fire(player, false);
            ammo--;
            ammoText.text = 'Ammo: ' + ammo;
            fired = true;
        }
    }
    // Dual Wield
    else if (game.input.activePointer.isDown && semi == true && current_weapon == 1) { 
        if (!fired) {    
            weapons[0].fire(player, true);
            ammo--;
            ammo--;
            ammoText.text = 'Ammo: ' + ammo;
            fired = true;
        }
    }
    // Automatic
    else if (game.input.activePointer.isDown && semi == false) {
        ammo--;
        ammoText.text = 'Ammo: ' + ammo;
        weapons[0].fire(player, false);
    }
    else {
        fired = false;
    }

//     game.physics.arcade.overlap(player, gorilla, collisionHandler, null, this);

    health_powerups.forEach(function(health) {
        game.physics.arcade.overlap(player, health, c_Health, null, this);
    });

    guns.forEach(function(gun) {
        game.physics.arcade.overlap(player, gun, c_Gun, null, this);
    });
    gorillas.forEach(function(gorilla) {
        if (player.position.x > gorilla.position.x){
            gorilla.position.x += .05;
        }
        if (player.position.y > gorilla.position.y){
            gorilla.position.y += .05;
        }
        if (player.position.x < gorilla.position.x){
            gorilla.position.x -= .05;
        }
        if (player.position.y < gorilla.position.y){
            gorilla.position.y -= .05;
        }
        
        gorilla.angle++;
    });
    game.physics.arcade.collide(player, gorillas);
    game.physics.arcade.overlap(player, gorillas, collide, null, this);
    //game.physics.arcade.collide(weapons[0].children[0], gorillas);
	//game.physics.arcade.overlap(weapons[0].children[0], gorillas, collide2, null, this);
    //console.log(weapons[0]);

}
function check_collide(x,y){
	
}
function collide2(x, y) {
    y.health--;
    x.kill(true);
    if (y.health <= 0){
       y.kill(true);
    }
}
function collide (x, y){
    health -= 10;
    healthText.text = 'Health: ' + health;

}
function c_Health(player, collider) {
    health += collider.collide();
    healthText.text = 'Health: ' + health;
}

function c_Gun(player, collider) {
    current_weapon = collider.collide();
    gunText.text = 'Current Gun: ' + current_weapon;
}
function collisionHandler(player, collider) {
    collider.collide();
}

</script>

</body>
</html>
