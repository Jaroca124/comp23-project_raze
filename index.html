<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Project Raze</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <script type="text/javascript" src="gun_methods.js"></script>
    <script type="text/javascript" src="enemy.js"></script>
    <script type="text/javascript" src="gorilla.js"></script>
    <script type="text/javascript" src="powerups.js"></script>
    <script type="text/javascript" src="panther.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, "game", { preload: preload, create: create, update: update });

function preload() {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.atlasJSONHash('sheet_small', 'assets/maps/sheet_small.png', 'assets/maps/sheet_small.json');
    game.load.image('bullet4', 'assets/bullet4.png');
    game.load.image('rude', 'assets/rude.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    // game.load.image('gorilla', 'assets/Gorilla_1.png');
    game.load.image('grass', 'assets/maps/grass_small.png');
    game.load.image('health_25', 'assets/health_25.png');
    game.load.image('health_50', 'assets/health_50.png');
    game.load.image('health_75', 'assets/health_75.png');
    game.load.image('gun_0', 'assets/gun_0.png');
    game.load.image('gun_1', 'assets/gun_1.png');
    game.load.image('gun_2', 'assets/gun_2.png');
    game.load.image('panther', 'assets/panther.png');
    game.renderer.renderSession.roundPixels = true;

    weapons = [];
    panthers = [];

}

//  Load various functions and objects
var platforms;
var score = 0;
var scoreText;
// Pistol = 0, Dual = 1, automatic = 2
var current_weapon = 1;
var fired = false;
var semi = true;
var health = 100;

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);
    this.cursors = game.input.keyboard.createCursorKeys();

    // Mapping new controls
    wasd = {
        up: game.input.keyboard.addKey(Phaser.Keyboard.W),
        down: game.input.keyboard.addKey(Phaser.Keyboard.S),
        right: game.input.keyboard.addKey(Phaser.Keyboard.D),
        left: game.input.keyboard.addKey(Phaser.Keyboard.A)
    };


    // Change to background images
    // LEFTOVER FROM OLD VER:
        // game.add.sprite(0, 0, 'sky');

    
    // gorillas = game.add.group();
    // gorillas.enableBody = true;
    // viewGroup = game.add.group();

    // gorilla = Gorilla(gorillas, 100, 100);

    var bg = game.add.tileSprite(0, 0, 800,600, 'grass');
    //var rock_test = game.add.sprite(50, 50, 'rock');


    // LEFTOVER FROM IMGS: The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'rude');
    player.anchor.setTo(0.5, 0.5);
    game.physics.enable(player, Phaser.Physics.ARCADE);
    player.enableBody = true;
    player.force = {x:0.0, y:0.0};

    weapons.push(new Weapon.SingleBullet(this.game));

    //Bind shot to spacebar
    game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);

    //Health
    health_powerups = game.add.group();
    for (var i = 0; i < 3; i++) {
        var health_objects = Health(health_powerups, 75, 250 + i*50, 250 + i*100);
    }
    healthText = game.add.text(16, 16, 'Health: ' + health, { fontSize: '32px', fill: '#000' });

    // Guns
    guns = game.add.group();
    var single = change_gun(guns, 0, 400, 400);
    var dual = change_gun(guns, 1, 300, 700);
    var auto = change_gun(guns, 2, 700, 300);
    gunText = game.add.text(400, 16, 'Current Gun: ' + current_weapon, { fontSize: '32px', fill: '#000' });

    //Panther
    Panthers = game.add.group();
    for (var i = 0; i < 1; i++) {
        panthers[i] = Panther(Panthers, 600, 0+i*100, player);
	panther_create(panthers[i]);
    }
    console.log(panthers[0].position);
    console.log(player.position);
    console.log(panthers[0].angle);
    //panther_create(panthers[0]);
}

function update() {
    
    var mX = game.input.mousePointer.x;
    var mY = game.input.mousePointer.y;
    /* look at the mouse */
    player.angle = Math.atan2(player.position.x - mX, player.position.y - mY)  * -57.2957795;
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;

    if (wasd.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -150;

        //player.animations.play('left');
    }
    if (wasd.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 150;

        //player.animations.play('right');
    }
    if (wasd.up.isDown) {
        player.body.velocity.y = -150;   
    }

    if (wasd.down.isDown) {
        player.body.velocity.y = 150;    
    }
    
    // Manage guns
    if (current_weapon == 0) {
        semi = true;
    }
    else if (current_weapon == 1) {
        semi = true;
    }
    else {
        semi = false;
    }
    //Fire Gun
    /*if (game.input.activePointer.isDown) {
        determine_gun(semi, current_weapon);
    }*/
    // Pistol
    if (game.input.activePointer.isDown && semi == true && current_weapon == 0) { 
        if (!fired) {    
            weapons[0].fire(player, false);
            fired = true;
        }
    }
    // Dual Wield
    else if (game.input.activePointer.isDown && semi == true && current_weapon == 1) { 
        if (!fired) {    
            weapons[0].fire(player, true);
            fired = true;
        }
    }
    // Automatic
    else if (game.input.activePointer.isDown && semi == false) {
        weapons[0].fire(player, false);
    }
    else {
        fired = false;
    }

//     game.physics.arcade.overlap(player, gorilla, collisionHandler, null, this);

    health_powerups.forEach(function(health) {
        game.physics.arcade.overlap(player, health, c_Health, null, this);
    });

    guns.forEach(function(gun) {
        game.physics.arcade.overlap(player, gun, c_Gun, null, this);
    });

	panther_update(panthers[0]);
}

function c_Health(player, collider) {
    health += collider.collide();
    healthText.text = 'Health: ' + health;
}

function c_Gun(player, collider) {
    current_weapon = collider.collide();
    gunText.text = 'Current Gun: ' + current_weapon;
}
function collisionHandler(player, collider) {
    collider.collide();
}

function panther_create(group) {
    console.log("ran create");
    panther_set_angle(group);
};

function panther_set_angle(group) {
    console.log(group);
    group.angle = Math.atan2(player.position.y-group.position.y,
			     player.position.x-group.position.x);
    //console.log(group.position);
    //console.log(player.position);
};

function panther_chase(group) {
    group.body.velocity.x = group.speed * Math.cos(group.angle);
    group.body.velocity.y = group.speed * Math.sin(group.angle);
    var debug = Math.cos(group.angle);
    //console.log(group.angle);
};

function panther_update(group) {
    //console.log("running update");
    panther_chase(group);
};

</script>

</body>
</html>
