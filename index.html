<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Project Raze</title>
    <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.image('bullet4', 'assets/bullet4.png');
    game.load.image('rude', 'assets/rude.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.renderer.renderSession.roundPixels = true;

    weapons = [];

}
 
//  Load various functions and objects
var platforms;
var score = 0;
var scoreText;

//Functions for Bullets
var Bullet = function (game, key) {
    Phaser.Sprite.call(this, game, 0, 0, key);
    this.texture.baseTexture.scaleMode = PIXI.scaleModes.NEAREST;
    this.anchor.set(0.5);
    this.checkWorldBounds = true;
    this.outOfBoundsKill = true;
    this.exists = false;
    this.tracking = false;
    this.scaleSpeed = 0;
};

Bullet.prototype = Object.create(Phaser.Sprite.prototype);
Bullet.prototype.constructor = Bullet;

Bullet.prototype.fire = function (x, y, angle, speed, gx, gy) {
    gx = gx || 0;
    gy = gy || 0;
    this.reset(x, y);
    this.scale.set(1);
    this.game.physics.arcade.velocityFromAngle(angle, speed, this.body.velocity);
    this.angle = angle;
    this.body.gravity.set(gx, gy);
};

Bullet.prototype.update = function () {
    if (this.tracking) {
        this.rotation = Math.atan2(this.body.velocity.y, this.body.velocity.x);
    }
    if (this.scaleSpeed > 0) {
        this.scale.x += this.scaleSpeed;
        this.scale.y += this.scaleSpeed;
    }
};

var Weapon = {};

Weapon.SingleBullet = function (game) {
    Phaser.Group.call(this, game, game.world, 'Single Bullet', false, true, Phaser.Physics.ARCADE);
    this.nextFire = 0;
    this.bulletSpeed = 400;
    this.fireRate = 100;

    for (var i = 0; i < 64; i++) {
        this.add(new Bullet(game, 'bullet4'), true);
    }

    return this;

};

Weapon.SingleBullet.prototype = Object.create(Phaser.Group.prototype);
Weapon.SingleBullet.prototype.constructor = Weapon.SingleBullet;

Weapon.SingleBullet.prototype.fire = function (source, Dual) {

    if (game.time.time < this.nextFire) { return; }
    var x;
    var y;
    if (Dual) {
        x = source.x + 20;
        y = source.y + 10;
        this.getFirstExists(false).fire(x, y, player.angle - 90, this.bulletSpeed, 0, 0);
        x = source.x + 0;
        y = source.y + 10;
        this.getFirstExists(false).fire(x, y, player.angle - 90, this.bulletSpeed, 0, 0);
    }
    else {
        x = source.x;// + 10;
        y = source.y + 50;// + 10;
        this.getFirstExists(false).fire(x, y, player.angle - 90, this.bulletSpeed, 0, 0);
    }

    this.nextFire = game.time.time + this.fireRate;

};

function create() {

    this.cursors = game.input.keyboard.createCursorKeys();

    // Mapping new controls
    wasd = {
        up: game.input.keyboard.addKey(Phaser.Keyboard.W),
        down: game.input.keyboard.addKey(Phaser.Keyboard.S),
        right: game.input.keyboard.addKey(Phaser.Keyboard.D),
        left: game.input.keyboard.addKey(Phaser.Keyboard.A)
    };


    // Change to background images
    game.add.sprite(0, 0, 'sky');


    // Here we create the ground.
    //var ground = platforms.create(0, game.world.height - 64, 'ground');

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    //ground.scale.setTo(2, 2);

    //  This stops it from falling away when you jump on it
    //ground.body.immovable = true;

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'rude');

    //  We need to enable physics on the player
    //game.physics.arcade.enable(player);

    //player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    //player.animations.add('left', [0, 1, 2, 3], 10, true);
    //player.animations.add('right', [5, 6, 7, 8], 10, true);

    weapons.push(new Weapon.SingleBullet(this.game));

    //Bind shot to spacebar
    game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]);

    
}

// Pistol = 0, Dual = 1, automatic = 2
var current_weapon = 2;
var fired = false;
var semi = true;

function update() {
    
     //  Collide the player and the stars with the platforms
    //game.physics.arcade.collide(player, platforms);
    //game.physics.arcade.collide(stars, platforms);

    var mX = game.input.mousePointer.x;
    var mY = game.input.mousePointer.y;
    /* look at the mouse */
    player.angle = Math.atan2(player.position.x - mX, player.position.y - mY)  * -57.2957795;

    if (wasd.left.isDown)
    {
        //  Move to the left
        player.x -= 3;

        //player.animations.play('left');
    }
    if (wasd.right.isDown)
    {
        //  Move to the right
        player.x += 3;

        //player.animations.play('right');
    }
    if (wasd.up.isDown) {
        player.y -= 3;   
    }

    if (wasd.down.isDown) {
        player.y += 3;    
    }
    
    // Manage guns
    if (current_weapon == 0) {
        semi = true;
    }
    else if (current_weapon == 1) {
        semi = true;
    }
    else {
        semi = false;
    }

    // Pistol
    if (game.input.activePointer.isDown && semi == true && current_weapon == 0) { 
        if (!fired) {    
            weapons[0].fire(player, false);
            fired = true;
        }
    }
    // Dual Wield
    else if (game.input.activePointer.isDown && semi == true && current_weapon == 1) { 
        if (!fired) {    
            weapons[0].fire(player, true);
            fired = true;
        }
    }
    // Automatic
    else if (game.input.activePointer.isDown && semi == false) {
        weapons[0].fire(player);
    }
    else {
        fired = false;
    }

}

</script>

</body>
</html>